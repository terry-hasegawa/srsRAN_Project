#
# Copyright 2021-2025 Software Radio Systems Limited
#
# By using this file, you agree to the terms and conditions set
# forth in the LICENSE file which can be found at the top level of
# the distribution.
#

[agent]
  interval                          = "${TELEGRAF_INPUT_INTERVAL:-1s}"
  flush_interval                    = "${TELEGRAF_OUTPUT_INTERVAL:-1s}"
  metric_buffer_limit               = ${TELEGRAF_BUFFER_LIMIT:-10000}
  hostname                          = "${INFLUXDB3_TESTBED}"
  skip_processors_after_aggregators = false
  quiet                             = ${TELEGRAF_QUIET:-true}
  debug                             = ${TELEGRAF_DEBUG:-false}
  logfile                           = "${TELEGRAF_LOG_FILE:-}"

# Inputs

[[inputs.execd]]
  command                     = ["/usr/local/bin/ws_adapter.py"]
  data_format                 = "xpath_json"
  buffer_size                 = "${TELEGRAF_INPUT_BUFFER_SIZE:-1MiB}"
  xpath_native_types          = true
  xpath_allow_empty_selection = true

  # UE Metrics
  [[inputs.execd.xpath]]
    metric_name      = "'ue'"
    metric_selection = "/cells/*/ue_list/*"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "child::*[not(name()='pci') and not(name()='rnti')]"
    [inputs.execd.xpath.tags]
      pci  = "number(pci)"
      rnti = "number(rnti)"

  # Cell Metrics
  [[inputs.execd.xpath]]
    metric_name      = "'cell'"
    metric_selection = "/cells/*/cell_metrics"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "descendant::*[not(*)]"

  # Event List
  [[inputs.execd.xpath]]
    metric_name      = "'event_list'"
    metric_selection = "/cells/*/event_list/*"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "descendant::*[not(*)]"

  # OFH
  [[inputs.execd.xpath]]
    metric_name          = "'ofh'"
    metric_selection     = "/ru/ofh/cells/*"
    timestamp            = "/timestamp"
    timestamp_format     = "2006-01-02T15:04:05.000"
    field_selection      = "descendant::*[not(*) and not(name()='pci')]"
    field_name_expansion = true
    [inputs.execd.xpath.tags]
      pci  = "number(pci)"

  # CU-CP Metrics
  [[inputs.execd.xpath]]
    metric_name      = "'cu_cp'"
    metric_selection = "/cu-cp"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "descendant::*[not(*) and not(name()='ngaps') and not(name()='rrcs')]"

  # NGAP Metrics
  [[inputs.execd.xpath]]
    metric_name      = "'ngaps'"
    metric_selection = "/cu-cp/ngaps/*/*"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "descendant::*[not(*) and not(name()='amf_name') and not(name()='pdu_session_management_s-nssai')]"
    field_name_expansion = true
    [inputs.execd.xpath.tags]
      amf_name  = "amf_name"
      snssai    = "pdu_session_management/s-nssai"

  # RRC Metrics
  [[inputs.execd.xpath]]
    metric_name      = "'rrcs'"
    metric_selection = "/cu-cp/rrcs/*/*"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "descendant::*[not(*) and not(name()='gnb_du_id')]"
    field_name_expansion = true
     [inputs.execd.xpath.tags]
       gnb_du_id  = "number(gnb_du_id)"

  # Fallback for other metrics
  [[inputs.execd.xpath]]
    metric_name          = "name(.)"
    metric_selection     = "/*[not(name()='timestamp') and not(name()='cells') and not(name()='ru') and not(name()='cu-cp') and not(name()='ngaps') and not(name()='rrcs') and not(name()='internal_') ]"
    timestamp            = "/timestamp"
    timestamp_format     = "2006-01-02T15:04:05.000"
    field_selection      = "descendant::*[not(*)]"
    field_name_expansion = true

[[inputs.internal]]
  # Internal Telegraf metrics
  interval = "${TELEGRAF_INPUT_INTERVAL:-1s}"

# Outputs

[[outputs.influxdb_v2]]
  urls              = ["${INFLUXDB3_EXTERNAL_URL}"]
  token             = "${INFLUXDB3_AUTH_TOKEN}"
  organization      = ""
  bucket            = "${INFLUXDB3_BUCKET}"
  content_encoding  = "gzip"
  rate_limit        = "${INFLUXDB3_RATE_LIMIT}"
  rate_limit_period = "${INFLUXDB3_RATE_LIMIT_PERIOD}"
  namedrop          = ["internal_*"] # Ignore internal metrics

[[outputs.health]]
  service_address = "http://:9273"
  namepass = ["internal_write"]
  tagpass  = { output = ["influxdb_v2"] }

  [[outputs.health.compares]]
    field  = "metrics_written"
    gt     = 0.0

  [[outputs.health.compares]]
    field  = "metrics_dropped"
    eq     = 0.0

  [[outputs.health.compares]]
    field  = "errors"
    eq     = 0.0

  [[outputs.health.compares]]
    field  = "startup_errors"
    eq     = 0.0

  [[outputs.health.compares]]
    field  = "metrics_rejected"
    eq     = 0.0
